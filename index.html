<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Keuangan Fasilitas Komplek PGRI</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232563eb'%3E%3Cpath d='M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm5-18v4h3V3h-3z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Public Report Page -->
    <div id="publicReportPage" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Laporan Keuangan Fasilitas Komplek PGRI</h1>
                            <p class="text-sm text-gray-600">Transparansi keuangan fasilitas komplek untuk Warga RT.03 dan RT.07</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <div id="syncStatus" class="flex items-center px-3 py-1 rounded-full text-xs">
                            <i class="fas fa-circle mr-1"></i>
                            <span>Offline</span>
                        </div>
                        <button id="adminLoginBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-user-shield mr-2"></i>Login Admin
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Google Apps Script Connection Status -->
            <div id="connectionAlert" class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                    <div>
                        <p class="text-blue-800 font-medium">Sistem Keuangan Online</p>
                        <p class="text-blue-700 text-sm">Semua data disimpan langsung ke Google Sheets. Pastikan koneksi
                            internet stabil untuk mengakses data terbaru.</p>
                    </div>
                </div>
            </div>

            <!-- Welcome Section -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Selamat Datang di Portal Keuangan</h2>
                    <p class="text-gray-600">Pantau transparansi keuangan fasilitas komplek PGRI secara real-time</p>
                </div>
            </div>

            <!-- Summary Cards for Public -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Pemasukan</p>
                            <p id="publicTotalMasuk" class="text-2xl font-bold text-green-600">Rp 0</p>
                            <p class="text-xs text-gray-500 mt-1">Iuran & Dana Masuk</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Pengeluaran</p>
                            <p id="publicTotalKeluar" class="text-2xl font-bold text-red-600">Rp 0</p>
                            <p class="text-xs text-gray-500 mt-1">Operasional & Pemeliharaan</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-arrow-down text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Saldo Kas</p>
                            <p id="publicSaldoAkhir" class="text-2xl font-bold text-blue-600">Rp 0</p>
                            <p class="text-xs text-gray-500 mt-1">Dana Tersedia</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-wallet text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Section for Public -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">Filter Laporan</h3>
                    <div class="flex gap-2 items-center">
                        <input type="date" id="publicStartDate"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <span class="text-gray-500">s/d</span>
                        <input type="date" id="publicEndDate"
                            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <button id="publicFilterBtn"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                        <button id="publicExportBtn"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-download mr-2"></i>Download
                        </button>
                    </div>
                </div>
            </div>

            <!-- Public Transaction Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-800">Riwayat Transaksi</h2>
                        <span id="publicTransactionCount" class="text-sm text-gray-500">0 transaksi</span>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tanggal</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Keterangan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Pemasukan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Pengeluaran</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="publicTransactionTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Info Footer -->
            <div class="mt-8 bg-blue-50 rounded-xl p-6">
                <div class="flex items-center justify-center text-center">
                    <div>
                        <i class="fas fa-info-circle text-blue-600 text-2xl mb-2"></i>
                        <p class="text-blue-800 font-medium">Laporan Transparan</p>
                        <p class="text-blue-600 text-sm mt-1">Data keuangan diperbarui secara berkala untuk transparansi
                            pengelolaan dana komplek</p>
                        <p class="text-blue-700 text-sm mt-2 font-bold italic">Programer By: Asriadi, S.PdI</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-white text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Aplikasi Keuangan Warga Komplek PGRI</h1>
                <p class="text-gray-600 mt-2">Sistem Laporan Keuangan Warga</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Masukkan username" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Masukkan password" required>
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login Admin
                </button>
            </form>


        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-800">Keuangan Komplek PGRI</h1>
                            <p class="text-sm text-gray-600">Dashboard Admin</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="adminSyncStatus" class="flex items-center px-3 py-1 rounded-full text-xs">
                            <i class="fas fa-circle mr-1"></i>
                            <span>Offline</span>
                        </div>
                        <button id="logoutBtn"
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Google Apps Script Setup -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Konfigurasi Google Apps Script</h3>
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL Web App</label>
                        <input type="text" id="webAppUrl"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600"
                            value="https://script.google.com/macros/s/AKfycbwH6-1QrqgJKveWwDwaTx9ruvkh6qLSQOyrzkYOgD9BRr6jRWUXSuV3mZzdDs1TGJDH/exec"
                            readonly>
                        <p class="text-xs text-gray-500 mt-1">URL Web App dari Google Apps Script yang sudah di-deploy
                        </p>
                    </div>
                </div>

            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Pemasukan</p>
                            <p id="totalMasuk" class="text-2xl font-bold text-green-600">Rp 0</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-arrow-up text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Total Pengeluaran</p>
                            <p id="totalKeluar" class="text-2xl font-bold text-red-600">Rp 0</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-arrow-down text-red-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Saldo Akhir</p>
                            <p id="saldoAkhir" class="text-2xl font-bold text-blue-600">Rp 0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-wallet text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <button id="addTransactionBtn"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                            <i class="fas fa-plus mr-2"></i>Tambah Transaksi
                        </button>

                        <div class="flex gap-2 items-center">
                            <input type="date" id="startDate"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <span class="text-gray-500">s/d</span>
                            <input type="date" id="endDate"
                                class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <button id="filterBtn"
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200">
                                <i class="fas fa-filter mr-2"></i>Filter
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button id="exportExcelBtn"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transaction Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">Daftar Transaksi</h2>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Tanggal</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Keterangan</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Masuk</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Keluar</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Saldo</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Transaction Modal -->
    <div id="transactionModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-800">Tambah Transaksi</h3>
            </div>

            <form id="transactionForm" class="p-6 space-y-4">
                <input type="hidden" id="editId">

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="date" id="transactionDate"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                    <input type="text" id="transactionDesc"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Contoh: Iuran Warga A" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Transaksi</label>
                    <select id="transactionType"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        required>
                        <option value="">Pilih Jenis</option>
                        <option value="masuk">Pemasukan</option>
                        <option value="keluar">Pengeluaran</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                    <input type="number" id="transactionAmount"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="0" min="0" required>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                    <button type="button" id="cancelBtn"
                        class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition duration-200">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Google Apps Script Configuration
        let googleSheetsConfig = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbwH6-1QrqgJKveWwDwaTx9ruvkh6qLSQOyrzkYOgD9BRr6jRWUXSuV3mZzdDs1TGJDH/exec',
            isConnected: false
        };

        // Data storage - only from Google Sheets, no local storage
        let transactions = [];

        let currentEditId = null;

        // DOM Elements
        const publicReportPage = document.getElementById('publicReportPage');
        const loginPage = document.getElementById('loginPage');
        const dashboardPage = document.getElementById('dashboardPage');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const transactionModal = document.getElementById('transactionModal');
        const transactionForm = document.getElementById('transactionForm');
        const addTransactionBtn = document.getElementById('addTransactionBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        // Google Apps Script API Functions
        class GoogleAppsScriptAPI {
            constructor(config) {
                this.config = config;
            }

            async testConnection() {
                try {
                    if (!this.config.webAppUrl) {
                        throw new Error('URL Web App belum dikonfigurasi');
                    }

                    const response = await fetch(this.config.webAppUrl + '?action=test', {
                        method: 'GET',
                        mode: 'no-cors'
                    });

                    // For no-cors mode, we can't read the response, so assume success if no error
                    this.config.isConnected = true;
                    this.updateConnectionStatus(true);
                    return { success: true, message: 'Koneksi berhasil!' };

                } catch (error) {
                    this.config.isConnected = false;
                    this.updateConnectionStatus(false);
                    return { success: false, message: 'Koneksi gagal: ' + error.message };
                }
            }

            async loadData() {
                try {
                    const response = await fetch(this.config.webAppUrl + '?action=getData', {
                        method: 'GET',
                        mode: 'cors'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data) {
                            // Replace local transactions with data from Google Sheets
                            transactions = result.data.map(row => ({
                                id: row.id || Date.now() + Math.random(),
                                date: row.date,
                                description: row.description,
                                masuk: parseInt(row.masuk) || 0,
                                keluar: parseInt(row.keluar) || 0,
                                saldo: parseInt(row.saldo) || 0
                            }));
                            console.log(`Loaded ${transactions.length} transactions from Google Sheets`);
                            return { success: true, count: transactions.length };
                        } else {
                            // No data in Google Sheets, keep empty array
                            transactions = [];
                            console.log('No data found in Google Sheets, starting with empty data');
                            return { success: true, count: 0 };
                        }
                    } else {
                        throw new Error('Failed to fetch data from Google Sheets');
                    }

                } catch (error) {
                    console.error('Load data error:', error);
                    // Keep transactions empty if loading fails
                    transactions = [];
                    throw new Error('Gagal memuat data: ' + error.message);
                }
            }

            async saveData() {
                try {
                    console.log('Sending data to Google Apps Script:', {
                        action: 'saveData',
                        data: transactions
                    });

                    // Prepare data for Google Apps Script
                    const payload = {
                        action: 'saveData',
                        data: transactions.map(t => ({
                            id: t.id,
                            date: t.date,
                            description: t.description,
                            masuk: t.masuk,
                            keluar: t.keluar,
                            saldo: t.saldo
                        }))
                    };

                    const response = await fetch(this.config.webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    // Since we're using no-cors mode, we can't read the response
                    // But the request should reach Google Apps Script
                    console.log('Data sent to Google Apps Script successfully');
                    return { success: true, message: 'Data berhasil dikirim ke Google Sheets' };

                } catch (error) {
                    console.error('Save data error:', error);
                    throw new Error('Gagal menyimpan: ' + error.message);
                }
            }

            updateConnectionStatus(isConnected) {
                const statusElements = [
                    document.getElementById('syncStatus'),
                    document.getElementById('adminSyncStatus')
                ];

                statusElements.forEach(element => {
                    if (element) {
                        const icon = element.querySelector('i');
                        const text = element.querySelector('span');

                        if (isConnected) {
                            element.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-green-100 text-green-800';
                            icon.className = 'fas fa-circle mr-1 text-green-500';
                            text.textContent = 'Online';
                        } else {
                            element.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-red-100 text-red-800';
                            icon.className = 'fas fa-circle mr-1 text-red-500';
                            text.textContent = 'Offline';
                        }
                    }
                });

                // Update connection alert
                const alert = document.getElementById('connectionAlert');
                if (alert) {
                    if (isConnected) {
                        alert.className = 'bg-green-50 border border-green-200 rounded-xl p-4 mb-6';
                        alert.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-green-800 font-medium">Terhubung ke Google Apps Script</p>
                                    <p class="text-green-700 text-sm">Data tersinkronisasi secara real-time dengan Google Sheets</p>
                                </div>
                            </div>
                        `;
                    } else {
                        alert.className = 'bg-red-50 border border-red-200 rounded-xl p-4 mb-6';
                        alert.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                                <div>
                                    <p class="text-red-800 font-medium">Tidak Terhubung ke Google Sheets</p>
                                    <p class="text-red-700 text-sm">Data tidak dapat disimpan. Periksa koneksi internet dan konfigurasi Google Apps Script.</p>
                                </div>
                            </div>
                        `;
                    }
                }
            }
        }

        // Initialize Google Apps Script API
        const googleSheets = new GoogleAppsScriptAPI(googleSheetsConfig);

        // Load configuration and data from Google Sheets only
        async function loadSavedConfig() {
            // Set default URL
            if (document.getElementById('webAppUrl')) {
                document.getElementById('webAppUrl').value = googleSheetsConfig.webAppUrl;
            }

            // Auto-test connection and load data from Google Sheets
            if (googleSheetsConfig.webAppUrl) {
                try {
                    const connectionResult = await googleSheets.testConnection();
                    if (connectionResult.success) {
                        console.log('Connected to Google Apps Script');

                        // Load data from Google Sheets only
                        try {
                            const loadResult = await googleSheets.loadData();
                            console.log(`Loaded ${loadResult.count} transactions from Google Sheets`);

                            // Update displays
                            recalculateSaldo();
                            updateSummary();
                            renderTransactionTable();
                            updatePublicSummary();
                            renderPublicTransactionTable();
                        } catch (loadError) {
                            console.log('Failed to load data from Google Sheets:', loadError.message);
                            alert('Gagal memuat data dari Google Sheets. Pastikan koneksi internet dan konfigurasi sudah benar.');
                        }
                    }
                } catch (error) {
                    console.log('Connection failed:', error.message);
                    alert('Tidak dapat terhubung ke Google Sheets. Periksa koneksi internet dan URL Google Apps Script.');
                }
            }
        }

        // Save configuration
        document.getElementById('saveConfigBtn')?.addEventListener('click', function () {
            const webAppUrl = document.getElementById('webAppUrl').value;

            if (webAppUrl) {
                googleSheetsConfig.webAppUrl = webAppUrl;
                alert('Konfigurasi berhasil disimpan!');
            } else {
                alert('Mohon masukkan URL Web App Google Apps Script');
            }
        });

        // Test connection
        document.getElementById('testConnectionBtn')?.addEventListener('click', async function () {
            const webAppUrl = document.getElementById('webAppUrl').value;

            if (!webAppUrl) {
                alert('Mohon masukkan URL Web App Google Apps Script');
                return;
            }

            googleSheetsConfig.webAppUrl = webAppUrl;

            const button = this;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';

            try {
                const result = await googleSheets.testConnection();
                alert(result.message);
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plug mr-2"></i>Test Koneksi';
            }
        });

        // Save data to Google Sheets (required for all operations)
        async function saveToGoogleSheets() {
            if (!googleSheetsConfig.webAppUrl) {
                alert('Google Apps Script belum dikonfigurasi! Data tidak dapat disimpan.');
                return false;
            }

            try {
                // Show syncing status
                updateSyncStatus('syncing');

                await googleSheets.saveData();
                console.log('Data saved to Google Sheets successfully');

                // Show success status
                updateSyncStatus('synced');

                // Return to online status after 2 seconds
                setTimeout(() => {
                    updateSyncStatus('online');
                }, 2000);

                return true;

            } catch (error) {
                console.error('Save to Google Sheets failed:', error);

                // Show error status
                updateSyncStatus('error');
                alert('Gagal menyimpan data ke Google Sheets: ' + error.message);

                // Return to online status after 3 seconds
                setTimeout(() => {
                    updateSyncStatus('online');
                }, 3000);

                return false;
            }
        }

        // Update sync status helper function
        function updateSyncStatus(status) {
            const statusElements = [
                document.getElementById('syncStatus'),
                document.getElementById('adminSyncStatus')
            ];

            statusElements.forEach(element => {
                if (element) {
                    const icon = element.querySelector('i');
                    const text = element.querySelector('span');

                    switch (status) {
                        case 'syncing':
                            element.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-800';
                            icon.className = 'fas fa-sync fa-spin mr-1 text-blue-500';
                            text.textContent = 'Syncing...';
                            break;
                        case 'synced':
                            element.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-green-100 text-green-800';
                            icon.className = 'fas fa-check-circle mr-1 text-green-500';
                            text.textContent = 'Synced';
                            break;
                        case 'error':
                            element.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-red-100 text-red-800';
                            icon.className = 'fas fa-exclamation-circle mr-1 text-red-500';
                            text.textContent = 'Sync Failed';
                            break;
                        case 'online':
                        default:
                            element.className = 'flex items-center px-3 py-1 rounded-full text-xs bg-green-100 text-green-800';
                            icon.className = 'fas fa-circle mr-1 text-green-500';
                            text.textContent = 'Online';
                            break;
                    }
                }
            });
        }

        // Navigation to admin login
        adminLoginBtn.addEventListener('click', function () {
            publicReportPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('username').focus();
        });

        // Login functionality
        loginForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === 'pgri2025') {
                loginPage.classList.add('hidden');
                dashboardPage.classList.remove('hidden');
                loadDashboard();
                loadSavedConfig();
            } else {
                alert('Username atau password salah!');
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', function () {
            dashboardPage.classList.add('hidden');
            publicReportPage.classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loadPublicReport();
        });

        // Load public report data
        function loadPublicReport() {
            updatePublicSummary();
            renderPublicTransactionTable();
            setPublicDefaultDates();
        }

        // Load dashboard data
        async function loadDashboard() {
            updateSummary();
            renderTransactionTable();
            setDefaultDates();

            // Load configuration when entering dashboard
            await loadSavedConfig();
        }

        // Update public summary cards
        function updatePublicSummary() {
            const totalMasuk = transactions.reduce((sum, t) => sum + t.masuk, 0);
            const totalKeluar = transactions.reduce((sum, t) => sum + t.keluar, 0);
            const saldoAkhir = totalMasuk - totalKeluar;

            document.getElementById('publicTotalMasuk').textContent = formatCurrency(totalMasuk);
            document.getElementById('publicTotalKeluar').textContent = formatCurrency(totalKeluar);
            document.getElementById('publicSaldoAkhir').textContent = formatCurrency(saldoAkhir);
        }

        // Update summary cards
        function updateSummary() {
            const totalMasuk = transactions.reduce((sum, t) => sum + t.masuk, 0);
            const totalKeluar = transactions.reduce((sum, t) => sum + t.keluar, 0);
            const saldoAkhir = totalMasuk - totalKeluar;

            document.getElementById('totalMasuk').textContent = formatCurrency(totalMasuk);
            document.getElementById('totalKeluar').textContent = formatCurrency(totalKeluar);
            document.getElementById('saldoAkhir').textContent = formatCurrency(saldoAkhir);
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Render public transaction table (read-only)
        function renderPublicTransactionTable(data = transactions) {
            const tbody = document.getElementById('publicTransactionTable');
            tbody.innerHTML = '';

            // Update transaction count
            document.getElementById('publicTransactionCount').textContent = `${data.length} transaksi`;

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>Belum ada transaksi</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(transaction.date)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">
                        ${transaction.masuk > 0 ? formatCurrency(transaction.masuk) : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">
                        ${transaction.keluar > 0 ? formatCurrency(transaction.keluar) : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">${formatCurrency(transaction.saldo)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Render transaction table
        function renderTransactionTable(data = transactions) {
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>Belum ada transaksi</p>
                        </td>
                    </tr>
                `;
                return;
            }

            data.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(transaction.date)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">
                        ${transaction.masuk > 0 ? formatCurrency(transaction.masuk) : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">
                        ${transaction.keluar > 0 ? formatCurrency(transaction.keluar) : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">${formatCurrency(transaction.saldo)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTransaction(${transaction.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Set default dates for public page
        function setPublicDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('publicStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('publicEndDate').value = today.toISOString().split('T')[0];
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        // Modal functions
        addTransactionBtn.addEventListener('click', function () {
            openModal('add');
        });

        cancelBtn.addEventListener('click', function () {
            closeModal();
        });

        function openModal(mode, transaction = null) {
            const modal = document.getElementById('transactionModal');
            const modalTitle = document.getElementById('modalTitle');

            if (mode === 'add') {
                modalTitle.textContent = 'Tambah Transaksi';
                transactionForm.reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                currentEditId = null;
            } else {
                modalTitle.textContent = 'Edit Transaksi';
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionDesc').value = transaction.description;
                document.getElementById('transactionType').value = transaction.masuk > 0 ? 'masuk' : 'keluar';
                document.getElementById('transactionAmount').value = transaction.masuk > 0 ? transaction.masuk : transaction.keluar;
                currentEditId = transaction.id;
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            transactionForm.reset();
            currentEditId = null;
        }

        // Transaction form submission
        transactionForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const date = document.getElementById('transactionDate').value;
            const description = document.getElementById('transactionDesc').value;
            const type = document.getElementById('transactionType').value;
            const amount = parseInt(document.getElementById('transactionAmount').value);

            if (currentEditId) {
                // Edit existing transaction
                const index = transactions.findIndex(t => t.id === currentEditId);
                if (index !== -1) {
                    transactions[index] = {
                        ...transactions[index],
                        date,
                        description,
                        masuk: type === 'masuk' ? amount : 0,
                        keluar: type === 'keluar' ? amount : 0
                    };
                }
            } else {
                // Add new transaction
                const newTransaction = {
                    id: Date.now(),
                    date,
                    description,
                    masuk: type === 'masuk' ? amount : 0,
                    keluar: type === 'keluar' ? amount : 0,
                    saldo: 0
                };
                transactions.push(newTransaction);
            }

            // Recalculate saldo
            recalculateSaldo();

            // Save to Google Sheets (required)
            const saved = await saveToGoogleSheets();
            if (saved) {
                // Update displays only if save successful
                updateSummary();
                renderTransactionTable();
                updatePublicSummary();
                renderPublicTransactionTable();
                closeModal();
            } else {
                // Revert changes if save failed
                if (currentEditId) {
                    // Reload data from Google Sheets to revert changes
                    await googleSheets.loadData();
                } else {
                    // Remove the added transaction
                    transactions.pop();
                }
                recalculateSaldo();
                updateSummary();
                renderTransactionTable();
            }
        });

        // Recalculate saldo for all transactions
        function recalculateSaldo() {
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));
            let runningSaldo = 0;

            transactions.forEach(transaction => {
                runningSaldo += transaction.masuk - transaction.keluar;
                transaction.saldo = runningSaldo;
            });
        }

        // Edit transaction
        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (transaction) {
                openModal('edit', transaction);
            }
        }

        // Delete transaction
        async function deleteTransaction(id) {
            if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
                // Store original data for rollback
                const originalTransactions = [...transactions];

                // Remove transaction
                transactions = transactions.filter(t => t.id !== id);
                recalculateSaldo();

                // Save to Google Sheets (required)
                const saved = await saveToGoogleSheets();
                if (saved) {
                    // Update displays only if save successful
                    updateSummary();
                    renderTransactionTable();
                    updatePublicSummary();
                    renderPublicTransactionTable();
                } else {
                    // Revert changes if save failed
                    transactions = originalTransactions;
                    recalculateSaldo();
                    updateSummary();
                    renderTransactionTable();
                }
            }
        }

        // Public filter functionality
        document.getElementById('publicFilterBtn').addEventListener('click', function () {
            const startDate = document.getElementById('publicStartDate').value;
            const endDate = document.getElementById('publicEndDate').value;

            if (startDate && endDate) {
                const filtered = transactions.filter(t => {
                    return t.date >= startDate && t.date <= endDate;
                });
                renderPublicTransactionTable(filtered);

                // Update summary for filtered data
                const totalMasuk = filtered.reduce((sum, t) => sum + t.masuk, 0);
                const totalKeluar = filtered.reduce((sum, t) => sum + t.keluar, 0);
                const saldoAkhir = totalMasuk - totalKeluar;

                document.getElementById('publicTotalMasuk').textContent = formatCurrency(totalMasuk);
                document.getElementById('publicTotalKeluar').textContent = formatCurrency(totalKeluar);
                document.getElementById('publicSaldoAkhir').textContent = formatCurrency(saldoAkhir);
            } else {
                alert('Silakan pilih rentang tanggal terlebih dahulu');
            }
        });

        // Filter functionality
        document.getElementById('filterBtn').addEventListener('click', function () {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (startDate && endDate) {
                const filtered = transactions.filter(t => {
                    return t.date >= startDate && t.date <= endDate;
                });
                renderTransactionTable(filtered);
            } else {
                alert('Silakan pilih rentang tanggal terlebih dahulu');
            }
        });

        // Public export to Excel
        document.getElementById('publicExportBtn').addEventListener('click', function () {
            const startDate = document.getElementById('publicStartDate').value;
            const endDate = document.getElementById('publicEndDate').value;

            let dataToExport = transactions;
            if (startDate && endDate) {
                dataToExport = transactions.filter(t => {
                    return t.date >= startDate && t.date <= endDate;
                });
            }

            const ws = XLSX.utils.json_to_sheet(dataToExport.map(t => ({
                'Tanggal': formatDate(t.date),
                'Keterangan': t.description,
                'Pemasukan (Rp)': t.masuk,
                'Pengeluaran (Rp)': t.keluar,
                'Saldo (Rp)': t.saldo
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Keuangan PGRI');

            const dateRange = startDate && endDate ? `_${startDate}_${endDate}` : '';
            const filename = `Laporan_Keuangan_PGRI${dateRange}_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        });

        // Export to Excel
        document.getElementById('exportExcelBtn').addEventListener('click', function () {
            const ws = XLSX.utils.json_to_sheet(transactions.map(t => ({
                'Tanggal': formatDate(t.date),
                'Keterangan': t.description,
                'Masuk (Rp)': t.masuk,
                'Keluar (Rp)': t.keluar,
                'Saldo (Rp)': t.saldo
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Keuangan');

            const filename = `Laporan_Keuangan_PGRI_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function () {
            // Initialize connection status
            googleSheets.updateConnectionStatus(false);

            // Auto-sync on startup
            await loadSavedConfig();

            // Load public report on startup
            loadPublicReport();
        });
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'97055dea803c3e35',t:'MTc1NTM5MzgxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>


</html>

